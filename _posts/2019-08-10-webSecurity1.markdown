---
layout: post
title:  "[웹 보안] 폼 인증을 사용할 때 ASP.NET에서 쿠키 재생 공격"
date:   2019-08-10 16:43:00
author: 이민석
categories: webSecurity
# tags:	jekyll welcome
# cover:  "/assets/instacode.png"
---

특정 사이트 보안감사에서 세션 하이재킹 기법으로 1건이 감지되어 해결하기 위해 삽질을 하면서 알게 된 사실을 포스팅 해보려 합니다.   

Microsoft ASP.NET 4.5 이전 버전은 폼 인증으로 세션을 로그아웃 할때 사용자 세션이 올바르게 종료되지 않는 약점이 있습니다.   
구글에서 FormsAuthentication.SignOut not working으로 검색하면 몇몇건이 검색됩니다..   
결과적으로 사용자는 웹에서 로그아웃한 후에도 세션 하이재킹 공격에 취약합니다.   

이 문제는 MS 공식 문서에도 기재되어 있었다고 하지만 현재는 사라져 보이지 않습니다. ㅠㅠ   

## 왜 중요한가?
많은 개발자들은 안전한 세션관리를 위해 개발 프레임 워크를 사용하며 개발자는 로그아웃 버튼을 클릭할 때 서버측의 FormsAuthentication.SignOut 메소드를 실행하여 사용자 세션이 제대로 종료되고 삭제되어 사용자가 효과적으로 로그아웃된 것을 예상하지만,   
**SignOut 메소드를 실행하여도 서버측의 세션이 파괴되지 않습니다.** (SessionTimeOut은 동작합니다.)

## 원인
FormsAuthentication.SignOut 메소드를 사용하면 웹 브라우저의 쿠키를 지웁니다.   
이후의 세션 토큰은 더 이상 서버로 전송되지 않으므로 서버는 더이상 인증된 세션과 연결되지 않습니다.   
하지만 연결되었던 쿠키를 저장했다가 쿠키를 임의로 설정하여 다시 전송하면 세션과 다시 연결됩니다.   
 
## 해결방법

아래와 같은 방법 이외에도 많은 방법이 있습니다.

 1. 사용자의 로그인 여부를 저장해야 합니다. 로그인 직후 bool값으로 로그인 True 설정하고 이 값을 세션 변수로 저장합니다.   
 2. 사용자가 로그아웃 버튼을 클릭하면 이 값을 False로 설정하거나 삭제합니다.   
 3. 웹 페이지 접근 전에 False 또는 삭제된 세션 변수 값으로 요청하면 액세스 거부 페이지로 Redirection 합니다.
